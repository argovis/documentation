

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Managing Argo Data &mdash; argovis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Getting started with Argovis API development" href="../api/getting_started.html" />
    <link rel="prev" title="Adding a new dataset" href="adding_new_data.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> argovis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">0. Welcome</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Argovis Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#argovis-engineering-at-a-glance">Argovis engineering at a glance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#documentation-conventions">Documentation conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#contributing">Contributing</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#table-of-contents">Table of contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="getting_started.html">Getting started with Argovis’ data</a></li>
<li class="toctree-l3"><a class="reference internal" href="schema.html">Argovis data schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="db_ops.html">Database Resourcing &amp; Deployment</a></li>
<li class="toctree-l3"><a class="reference internal" href="adding_new_data.html">Adding a new dataset</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Managing Argo Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#opinionated-profiles">Opinionated profiles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nightly-updates-integrity-checking">Nightly updates &amp; integrity checking</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/getting_started.html">Getting started with Argovis API development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/adding_new_endpoints.html">Adding new API routes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/rate_limitation.html">API rate limitation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/ops_config.html">API deployment configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/hit_logging.html">API hit logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/deployment.html">Argovis Deployment Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/drifters-aws.html">Deploy Global Drifter Program database on AWS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/openshift-ssl.html">Openshift SSL Certificate Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/prometheus.html">Prometheus metrics for Argovis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/intro.html">Appendix: Archival Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/using_branches.html">Using Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/api_usage.html">Argovis API Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/performance_testing.html">Performance Testing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">1. Data &amp; Database</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with Argovis’ data</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Argovis data schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="db_ops.html">Database Resourcing &amp; Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="adding_new_data.html">Adding a new dataset</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Managing Argo Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#opinionated-profiles">Opinionated profiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#upstream-file-selection">Upstream file selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-extraction">Data extraction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#metadata-extraction">Metadata extraction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#level-data-extraction">Level data extraction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#data-merging">Data merging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#metadata-merge">Metadata merge</a></li>
<li class="toctree-l4"><a class="reference internal" href="#level-data-merge">Level data merge</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#database-considerations">Database considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#known-omissions">Known omissions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nightly-updates-integrity-checking">Nightly updates &amp; integrity checking</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">2. API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/getting_started.html">Getting started with Argovis API development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/adding_new_endpoints.html">Adding new API routes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/rate_limitation.html">API rate limitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/ops_config.html">API deployment configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/hit_logging.html">API hit logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">4. Deployment &amp; operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/deployment.html">Argovis Deployment Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/drifters-aws.html">Deploy Global Drifter Program database on AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/openshift-ssl.html">Openshift SSL Certificate Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/prometheus.html">Prometheus metrics for Argovis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix: Archival Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/intro.html">Appendix: Archival Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/using_branches.html">Using Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/api_usage.html">Argovis API Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/performance_testing.html">Performance Testing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">argovis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Managing Argo Data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/database/argo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="managing-argo-data">
<span id="argo-merge"></span><h1>Managing Argo Data<a class="headerlink" href="#managing-argo-data" title="Permalink to this headline">¶</a></h1>
<p>Other than the <code class="docutils literal notranslate"><span class="pre">argo</span></code> collection, all other collections in Argovis are essentially <em>static</em>: the expectation is that they will be updated infrequently and ad-hoc, and the scripts linked above that translate from upstream formats to MongoDB documents are largely simple and unopinonated, mapping keys to keys.</p>
<p>Argo data, on the other hand, is actively managed in two ways:</p>
<blockquote>
<div><ul class="simple">
<li><p>Argovis constructs a <em>simplified, opinionated profile</em> for each profile object, that imposes some expertise in interpreting Argo data correctly. This is intended to help downstream consumers who are not experts in Argo’s data collection patterns interpret data correctly, while removing as few useful options for them as possible.</p></li>
<li><p>The Argo collections in MongoDB are automatically updated nightly, and actively monitored for corruption.</p></li>
</ul>
</div></blockquote>
<p>Considerations around both these points are enumerated below.</p>
<div class="section" id="opinionated-profiles">
<h2>Opinionated profiles<a class="headerlink" href="#opinionated-profiles" title="Permalink to this headline">¶</a></h2>
<p>A given Argo profile may contain two separate data objects: a core profile measuring pressure, temperature, and salinity; and a BGC profile measuring one or several of many biogeochemical properties. Furthermore, this data may be presented in one of several different modes reflecting the level of cleanup the data has undergone. Argovis seeks to create a single unified JSON document for each profile that merges the core and BGC information and makes good and consistent choices on what mode of data to present, simplifying the consumption of Argo data for users while still accommodating the majority of use cases. This document describes how we take upstream data, and compose it into a JSON document; it effectively describes the algorithm implemented in <a class="reference external" href="https://github.com/argovis/ifremer-sync">https://github.com/argovis/ifremer-sync</a>.</p>
<div class="section" id="upstream-file-selection">
<h3>Upstream file selection<a class="headerlink" href="#upstream-file-selection" title="Permalink to this headline">¶</a></h3>
<p>For a given profile, first we choose which upstream netcdf files to consider. There are six possibilities: core, BGC, and synthetic files, each reflecting either realtime or delayed data. We choose at most two of these:</p>
<blockquote>
<div><ul class="simple">
<li><p>We prefer the synthetic delayed file to capture BGC information, but accept the synthetic realtime in lieu;</p></li>
<li><p>We prefer the delayed core file to capture core information, but accept the realtime core file in lieu.</p></li>
</ul>
</div></blockquote>
<p>Under no circumstances are standalone BGC files considered at this time.</p>
</div>
<div class="section" id="data-extraction">
<h3>Data extraction<a class="headerlink" href="#data-extraction" title="Permalink to this headline">¶</a></h3>
<p>Once at most one core and at most one synthetic file are identified for a profile, we extract data from each separately as follows.</p>
<div class="section" id="metadata-extraction">
<h4>Metadata extraction<a class="headerlink" href="#metadata-extraction" title="Permalink to this headline">¶</a></h4>
<p>Some metadata variables undergo cleaning decisions at this step, as enumerated here:</p>
<ul class="simple">
<li><p><strong>Latitude and longitude</strong> are read from the Argo file’s LATITUDE and LONGITUDE variables. If either value is NaN or a fill value, they are set to longitude = 0, latitude = -90 and a <code class="docutils literal notranslate"><span class="pre">missing_location</span></code> warning is logged in the <code class="docutils literal notranslate"><span class="pre">data_warnings</span></code> record. If longitude is reported on [0,360], it is normalized to [-180,180].</p></li>
<li><p><strong>_id</strong> is constructed as <code class="docutils literal notranslate"><span class="pre">&lt;platform_id&gt;_&lt;cycle_number&gt;</span></code>, with <code class="docutils literal notranslate"><span class="pre">D</span></code> appended for decending profiles.</p></li>
<li><p><strong>Basin</strong> is read from a lookup table as a function of extracted latitude and longitude, if a valid pair was found. If the nearest basin gridpoint is NaN, the nearest non-NaN grid point is taken. If all four surrounding grid points are NaN, a <code class="docutils literal notranslate"><span class="pre">missing_basin</span></code> warning is logged and the basin index is set to -1.</p></li>
<li><p><strong>source_info.source</strong> is populated as <code class="docutils literal notranslate"><span class="pre">argo_core</span></code> for core files and <code class="docutils literal notranslate"><span class="pre">argo_bgc</span></code> for synthetic files. If the deepest pressure in the file is greater than 2500 dbar, an <code class="docutils literal notranslate"><span class="pre">argo_deep</span></code> flag is also added.</p></li>
</ul>
<p>All other metadata variables are read directly from the corresponding netcdf variables, with minimal typecasting and cleanup.</p>
</div>
<div class="section" id="level-data-extraction">
<h4>Level data extraction<a class="headerlink" href="#level-data-extraction" title="Permalink to this headline">¶</a></h4>
<p>Per-level data is extracted slightly differently for core versus BGC variables.</p>
<ul class="simple">
<li><p><strong>Core variables</strong> are read with the following considerations:</p>
<ul>
<li><p>Only pressure, temperature, and salinity and their QC are considered in core files. If any other per-level variables are present, they are discarded.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">DATA_MODE</span></code> for the file is delayed or adjusted, only variables marked <code class="docutils literal notranslate"><span class="pre">_ADJUSTED</span></code> are considered.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">DATA_MODE</span></code> for the file is realtime, then non-adjusted variables are accepted.</p></li>
<li><p>All variables are assigned a per-variable data mode that matches the file-level data mode</p></li>
<li><p>If two levels report the same pressure, a <code class="docutils literal notranslate"><span class="pre">degenerate_level</span></code> warning is logged</p></li>
<li><p>Levels are thrown out if they report NaN for pressure.</p></li>
</ul>
</li>
<li><p><strong>BGC variables</strong> are read with the following considerations:</p>
<ul>
<li><p>Data mode is determined per variable; if delayed or adjusted mode data is available for a given variable, its <code class="docutils literal notranslate"><span class="pre">_ADJUSTED</span></code> entry is taken; if only realtime is available for that variable, then the unadjusted value is accepted.</p></li>
<li><p>Degenerate level warnings and NaN-pressure level ommissions are per the core data case.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">temp</span></code> or <code class="docutils literal notranslate"><span class="pre">psal</span></code> are reported in a synthetic file, they are relabeled as <code class="docutils literal notranslate"><span class="pre">temp_sfile</span></code> and <code class="docutils literal notranslate"><span class="pre">psal_sfile</span></code> respectively, along with their QC.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="data-merging">
<h3>Data merging<a class="headerlink" href="#data-merging" title="Permalink to this headline">¶</a></h3>
<p>At this stage, there may be as many as two metadata objects, and the same number of data objects for the profile in question. These are merged to a single record per the following.</p>
<div class="section" id="metadata-merge">
<h4>Metadata merge<a class="headerlink" href="#metadata-merge" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>For mandatory keys that should be the same in both metadata objects (like <code class="docutils literal notranslate"><span class="pre">_id</span></code> and <code class="docutils literal notranslate"><span class="pre">geolocation</span></code>), the value from the first metadata record is accepted.</p></li>
<li><p>For optional keys that should be the same in both metadata objects, the value from the first metadata object that reports that key is accepted.</p></li>
<li><p>For keys that preserve a record from each file (like <code class="docutils literal notranslate"><span class="pre">source_info</span></code> and <code class="docutils literal notranslate"><span class="pre">data_warnings</span></code>), the value from each metadata record, if present, is appended to a list.</p></li>
</ul>
</div>
<div class="section" id="level-data-merge">
<h4>Level data merge<a class="headerlink" href="#level-data-merge" title="Permalink to this headline">¶</a></h4>
<p>Per-level data is merged along a one-dimensional pressure axis with the following considerations:</p>
<ul class="simple">
<li><p>If an individual file’s data object carries a <code class="docutils literal notranslate"><span class="pre">degenerate_levels</span></code> warning, the per level data from that file is discarded.</p></li>
<li><p>For each observed pressure level, the value of each observed variable and their corresponding QC is recorded, with <code class="docutils literal notranslate"><span class="pre">None</span></code> used as a fill for absent information.</p></li>
<li><p>Per-variable data mode is preserved for each variable. If pressure reports a different data mode in core versus synthetic files, the lowest confidence mode is reported: realtime supersedes adjusted supersedes delayed.</p></li>
<li><p>For each individual value, the following normalization is performed:</p>
<ul>
<li><p>bytes are converted to ints (Argo reports QC as byte characters)</p></li>
<li><p>NaNs are converted to pythonic <code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
<li><p>Floats are rounded to at most six decimal places</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="database-considerations">
<h3>Database considerations<a class="headerlink" href="#database-considerations" title="Permalink to this headline">¶</a></h3>
<p>At the end of the process described above, we have a single JSON document describing the profile of interest, to be written to MongoDB. Write considerations are as follows:</p>
<ul class="simple">
<li><p>MongoDB’s internal time bson type does not capture sub-millisecond precision; therefore, all times will be rounded off to the ms on write.</p></li>
</ul>
</div>
<div class="section" id="known-omissions">
<h3>Known omissions<a class="headerlink" href="#known-omissions" title="Permalink to this headline">¶</a></h3>
<p>Some pathologies in the original data files can cause a profile to fail to write to MongoDB. Observed such conditions are listed here:</p>
<blockquote>
<div><ul class="simple">
<li><p>Missing <code class="docutils literal notranslate"><span class="pre">PARAMETER_DATA_MODE</span></code>: Argovis has a firm expectation that all variables in a BGC file are reported as exactly one of real-time, adjusted or delayed; if a fill value is detected for any variable in a profile, the profile is omitted.</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="nightly-updates-integrity-checking">
<h2>Nightly updates &amp; integrity checking<a class="headerlink" href="#nightly-updates-integrity-checking" title="Permalink to this headline">¶</a></h2>
<p>See our <a class="reference external" href="https://github.com/argovis/ifremer-sync/blob/main/ifremer-cron.yaml">Kubernetes cron job specification</a> for the orchestration and logic that govern nightly Argo collection updates. At high level:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rsync</span></code> downloads anything new since last time to Argovis’ local IFREMER mirror.</p></li>
<li><p>A script parses the <code class="docutils literal notranslate"><span class="pre">rsync</span></code> logs and decides on CRUD operations to perform on the database.</p></li>
<li><p>A python script performs the enumerated CRUD ops.</p></li>
<li><p>A log is preserved for auditing purposes</p></li>
</ul>
</div></blockquote>
<p>Integrity checking is described in detail in <a class="reference external" href="https://github.com/argovis/ifremer-sync#integrity-checking">these docs</a> and related scripts. It’s best practice for Argovis operators to review the logs of this auditing script periodically to ensure nothing unexpected is happening in the nightly updates.</p>
<p><em>Last reviewed 23-03-06</em></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../api/getting_started.html" class="btn btn-neutral float-right" title="Getting started with Argovis API development" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="adding_new_data.html" class="btn btn-neutral float-left" title="Adding a new dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Argovis Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>