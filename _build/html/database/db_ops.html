

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Database Resourcing &amp; Deployment &mdash; argovis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Adding a new dataset" href="adding_new_data.html" />
    <link rel="prev" title="Argovis data schema" href="schema.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> argovis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">0. Welcome</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Argovis Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#argovis-engineering-at-a-glance">Argovis engineering at a glance</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#documentation-conventions">Documentation conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#contributing">Contributing</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#table-of-contents">Table of contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="getting_started.html">Getting started with Argovis’ data</a></li>
<li class="toctree-l3"><a class="reference internal" href="schema.html">Argovis data schema</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Database Resourcing &amp; Deployment</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#deployment-topology">Deployment topology</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resourcing">Resourcing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disaster-recovery">Disaster Recovery</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="adding_new_data.html">Adding a new dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="argo.html">Managing Argo Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/getting_started.html">Getting started with Argovis API development</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/adding_new_endpoints.html">Adding new API routes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/rate_limitation.html">API rate limitation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/ops_config.html">API deployment configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/hit_logging.html">API hit logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/deployment.html">Argovis Deployment Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/drifters-aws.html">Deploy Global Drifter Program database on AWS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ops/openshift-ssl.html">Openshift SSL Certificate Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/intro.html">Appendix: Archival Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/using_branches.html">Using Branches</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/api_usage.html">Argovis API Usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../special_topics/performance_testing.html">Performance Testing</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">1. Data &amp; Database</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with Argovis’ data</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Argovis data schema</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Database Resourcing &amp; Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#deployment-topology">Deployment topology</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resourcing">Resourcing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disaster-recovery">Disaster Recovery</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="adding_new_data.html">Adding a new dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="argo.html">Managing Argo Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">2. API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/getting_started.html">Getting started with Argovis API development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/adding_new_endpoints.html">Adding new API routes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/rate_limitation.html">API rate limitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/ops_config.html">API deployment configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/hit_logging.html">API hit logging</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">4. Deployment &amp; operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/deployment.html">Argovis Deployment Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/drifters-aws.html">Deploy Global Drifter Program database on AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/openshift-ssl.html">Openshift SSL Certificate Management</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix: Archival Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/intro.html">Appendix: Archival Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/using_branches.html">Using Branches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/api_usage.html">Argovis API Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/performance_testing.html">Performance Testing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">argovis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Database Resourcing &amp; Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/database/db_ops.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="database-resourcing-deployment">
<span id="db-ops"></span><h1>Database Resourcing &amp; Deployment<a class="headerlink" href="#database-resourcing-deployment" title="Permalink to this headline">¶</a></h1>
<p>Enumerated below are some basic considerations for deploying and operating MongoDB for Argovis.</p>
<div class="section" id="deployment-topology">
<h2>Deployment topology<a class="headerlink" href="#deployment-topology" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>As noted above, each instance of Argovis (Core and all satellite deployments) each run their own instance of stand-alone MongoDB, currently 5.09.</p></li>
<li><p>As all Argovis software is always containerized, ensure appropriate networking tools are in place when deploying MongoDB so that other containers can reach it; this means an attachable overlay network in Swarm, or an appropriate clusterIP object in Kubernetes. Other components will attempt to resolve MongoDB at the in-cluster DNS name <code class="docutils literal notranslate"><span class="pre">database</span></code>.</p></li>
<li><p>MongoDB by default writes all data to <code class="docutils literal notranslate"><span class="pre">/data/db</span></code> inside its container. Make sure sufficient storage is mounted there, and that it is backed up regularly.</p></li>
<li><p>In Kubernetes, impose a memory and cpu request if quota is available, to discourage rescheduling of MongoDB.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="resourcing">
<h2>Resourcing<a class="headerlink" href="#resourcing" title="Permalink to this headline">¶</a></h2>
<p>Ideally, MongoDB should be provisioned with enough RAM to hold the entire working set and all indexes for all collections in memory. Since as with most scientific datasets there is no way to define a subset of general interest or priority, this means enough RAM to hold <em>everything</em>, indexes as well as complete collections. Since this is often unrealistic, an adequate compromise is to provision enough RAM for your indexes, and enough fast disk for everything else; these disks <em>must</em> be SSD and <em>must</em> be either physically mounted in the same server as the container host or connected to it by very fast intra-datacenter networking. HDDs over NFS will not be adequate.</p>
<p>One dedicated current-gen CPU per MongoDB instance should be plenty.</p>
</div>
<div class="section" id="disaster-recovery">
<h2>Disaster Recovery<a class="headerlink" href="#disaster-recovery" title="Permalink to this headline">¶</a></h2>
<p>In the event of a catastrophic failure of MongoDB, you may need to restore from an image of the storage mounted to <code class="docutils literal notranslate"><span class="pre">/data/db</span></code> inside your MongoDB container. Note that this is the only place Argovis persists critical information on disk; all other components are stateless and can be safely destroyed and recreated as needed. Ideally, MongoDB should be cleanly stopped before creating this backup, but this is in practice difficult to coordinate with storage teams. In the event that the database must be restored from a hot storage backup, consider a couple of increasingly dire mitigations:</p>
<blockquote>
<div><ul class="simple">
<li><p>If we’re lucky, simply copying or re-mounting the complete set of database image files from the backup location to <code class="docutils literal notranslate"><span class="pre">/data/db</span></code> might work.</p></li>
<li><p>If mongo continues to refuse to start, try starting it with the <code class="docutils literal notranslate"><span class="pre">--repair</span></code> flag, as presented <a class="reference external" href="https://www.mongodb.com/docs/manual/tutorial/recover-data-following-unexpected-shutdown/">here</a>.</p></li>
<li><p>If mongo repair fails, try removing the journal and <code class="docutils literal notranslate"><span class="pre">mongo.lock</span></code> files from <code class="docutils literal notranslate"><span class="pre">/data/db</span></code> (while of course being careful to keep a backup of them), and starting with <code class="docutils literal notranslate"><span class="pre">--repair</span></code> again; this is an extreme measure that should be avoided, but has saved our database in the past.</p></li>
</ul>
</div></blockquote>
<p><em>Last reviewed 2023-03-06</em></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="adding_new_data.html" class="btn btn-neutral float-right" title="Adding a new dataset" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="schema.html" class="btn btn-neutral float-left" title="Argovis data schema" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Argovis Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>