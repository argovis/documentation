

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Restore Mongo from Backup &mdash; argovis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Connecting to the Container Network" href="../special_topics/connecting_to_the_container_network.html" />
    <link rel="prev" title="Using Branches" href="../dev_tools/using_branches.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> argovis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/set_up_dev_environment.html">Setting Up Argovis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/api_development.html">API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/custom_angular_components.html">Creating Custom Angular Components</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations Playbooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/deployment.html">Argovis Kubernetes Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/performance_testing.html">Performance Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_management/point_schema.html">Point Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_management/argo_merge.html">Merging Argo Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Tools &amp; Techniques</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/fast_development_builds.html">Fast Angular Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/using_branches.html">Using Branches</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Disaster Recovery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Restore Mongo from Backup</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#local-database-restoration">Local Database Restoration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#production-database-backup-restore-strategy">Production Database Backup &amp; Restore Strategy</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Special Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/profiles-alpha.html">Profiles API Alpha Product</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">argovis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Restore Mongo from Backup</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/disaster_recovery/restore_a_mongo_collection.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="restore-mongo-from-backup">
<h1>Restore Mongo from Backup<a class="headerlink" href="#restore-mongo-from-backup" title="Permalink to this headline">¶</a></h1>
<p>In the event of a database failure or migration, we may need to restore MongoDB databases and collections from backups. In this tutorial, you’ll learn how to do so, on a local deployment in the first section, and for the production database in the second.</p>
<div class="section" id="local-database-restoration">
<h2>Local Database Restoration<a class="headerlink" href="#local-database-restoration" title="Permalink to this headline">¶</a></h2>
<p>In this section, we assume you have a docker-compose orchestrated instance of argovis on your own machine for deelopment purposes, and a <code class="docutils literal notranslate"><span class="pre">profiles.bson</span></code> generated by <code class="docutils literal notranslate"><span class="pre">mongodump</span></code> you want to load into your local database.</p>
<ol class="arabic">
<li><p>First, we need to figure out where to put our backed up data so mongo can read it back in. Start by listing your containers; you should see something like the example output below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container ls

CONTAINER ID   IMAGE                      ...
6d9e71e4d6db   argovis/ng:dev.            ...
feeac652a257   mongo:4.2.3                ...
</pre></div>
</div>
</li>
</ol>
<p>You’re interested in the container ID of the container using the <code class="docutils literal notranslate"><span class="pre">mongo</span></code> image, <code class="docutils literal notranslate"><span class="pre">feeac652a257</span></code> in my example (yours will be different).</p>
<ol class="arabic" start="2">
<li><p>Use the container ID you found to inspect that container and determine its filesystem mount points; you’re looking for the <code class="docutils literal notranslate"><span class="pre">Mounts</span></code> block in the output generated:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container inspect &lt;mongo container ID&gt;

  <span class="s2">&quot;Mounts&quot;</span>: <span class="o">[</span>
      <span class="o">{</span>
          <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;volume&quot;</span>,
          <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;1946b3562a81...&quot;</span>,
          <span class="s2">&quot;Source&quot;</span>: <span class="s2">&quot;/var/lib/docker/volumes/1946b3562a81.../_data&quot;</span>,
          <span class="s2">&quot;Destination&quot;</span>: <span class="s2">&quot;/data/configdb&quot;</span>,
          <span class="s2">&quot;Driver&quot;</span>: <span class="s2">&quot;local&quot;</span>,
          <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;&quot;</span>,
          <span class="s2">&quot;RW&quot;</span>: true,
          <span class="s2">&quot;Propagation&quot;</span>: <span class="s2">&quot;&quot;</span>
      <span class="o">}</span>,
      <span class="o">{</span>
          <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;bind&quot;</span>,
          <span class="s2">&quot;Source&quot;</span>: <span class="s2">&quot;/home/ubuntu/argovis-tutorial/data/argovis/storage/mongodb&quot;</span>,
          <span class="s2">&quot;Destination&quot;</span>: <span class="s2">&quot;/data/db&quot;</span>,
          <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;Z&quot;</span>,
          <span class="s2">&quot;RW&quot;</span>: true,
          <span class="s2">&quot;Propagation&quot;</span>: <span class="s2">&quot;rprivate&quot;</span>
      <span class="o">}</span>
  <span class="o">]</span>,
</pre></div>
</div>
</li>
</ol>
<p>You’re interested in the <code class="docutils literal notranslate"><span class="pre">Source</span></code> directory associated with the <code class="docutils literal notranslate"><span class="pre">&quot;Destination&quot;:</span> <span class="pre">&quot;/data/db&quot;</span></code>. That <code class="docutils literal notranslate"><span class="pre">Source</span></code> location is the directory on your machine where you need to place your mongo collection backup, in my example <code class="docutils literal notranslate"><span class="pre">/home/ubuntu/argovis-tutorial/data/argovis/storage/mongodb</span></code>.</p>
<ol class="arabic" start="3">
<li><p>Change to the <code class="docutils literal notranslate"><span class="pre">Source</span></code> path you found above, and make a subdirectory to hold your backup bson and metadata; I’ll call this subdirectory <code class="docutils literal notranslate"><span class="pre">goship</span></code>, but you can name yours as appropriate:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ <span class="nb">cd</span> /home/ubuntu/argovis-tutorial/data/argovis/storage/mongodb

mongodb $ mkdir goship
</pre></div>
</div>
</li>
</ol>
<p>Place your mongo collection backup bson and metadata in that subdirectory; mine are called <code class="docutils literal notranslate"><span class="pre">profiles.bson</span></code> and <code class="docutils literal notranslate"><span class="pre">profiles.metadata.json</span></code>, but it can be called anything you like.</p>
<ol class="arabic" start="3">
<li><p>Tell mongo to re-load your collection from backup. Make sure to insert the mongo container ID you found above, modify the <code class="docutils literal notranslate"><span class="pre">goship</span></code> part of the path to match the subdirectory you made above, and feel free to change the <code class="docutils literal notranslate"><span class="pre">--db</span></code> and <code class="docutils literal notranslate"><span class="pre">--collection</span></code> flags to name your database and collections anything you like.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container <span class="nb">exec</span> &lt;mongo container ID&gt; <span class="se">\</span>
    mongorestore --batchSize<span class="o">=</span><span class="m">64</span> <span class="se">\</span>
    --db<span class="o">=</span>goship --collection<span class="o">=</span>profiles <span class="se">\</span>
    /data/db/goship/profiles.bson
</pre></div>
</div>
</li>
</ol>
<div class="admonition-warning admonition">
<p class="admonition-title">Warning</p>
<p>Collection restoration is a memory intensive process! While the restoration proceeds, make sure to monitor memory usage and ensure it doesn’t exceed what’s available. If so, kill the restore and decrease the <code class="docutils literal notranslate"><span class="pre">--batchSize</span></code> parameter to reduce the amount of memory allocated by mongo on restore.</p>
</div>
<ol class="arabic" start="4">
<li><p>Validate that your database was restored by creating an interactive connection to your mongodb and listing your databases:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container <span class="nb">exec</span>  -it &lt;mongo container ID&gt; mongo

&gt; show dbs

admin   <span class="m">0</span>.000GB
argo    <span class="m">0</span>.003GB
config  <span class="m">0</span>.000GB
goship  <span class="m">2</span>.464GB
<span class="nb">local</span>   <span class="m">0</span>.000GB

&gt; <span class="nb">exit</span>
</pre></div>
</div>
</li>
</ol>
<p>I can see my <code class="docutils literal notranslate"><span class="pre">goship</span></code> database is present and has content, so this looks good. Before exiting, feel free to explore some more to make sure your data has been restored in the way you expect.</p>
<ol class="arabic" start="5">
<li><p>After re-loading data, your container might have allocated a large amount of memory during restore.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container stats --no-stream

CONTAINER ID   NAME                       CPU %     MEM USAGE / LIMIT     MEM % ...
cf17e99f65c5   argovisng_ng_1             <span class="m">0</span>.27%     <span class="m">67</span>.81MiB / <span class="m">31</span>.36GiB   <span class="m">0</span>.21% ...
c5f477eb4a83   argovisng_database_1       <span class="m">0</span>.24%     12GiB / <span class="m">31</span>.36GiB      <span class="m">38</span>.28%...
</pre></div>
</div>
</li>
</ol>
<p>In this example, after I restored my goship database, the database container has allocated a whopping 12 GB of memory. Restart the container to flush memory:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ docker container restart &lt;database container ID&gt;
</pre></div>
</div>
</div></blockquote>
<p>Check your container stats again and your database should have freed up most of the memory it was consuming.</p>
</div>
<div class="section" id="production-database-backup-restore-strategy">
<h2>Production Database Backup &amp; Restore Strategy<a class="headerlink" href="#production-database-backup-restore-strategy" title="Permalink to this headline">¶</a></h2>
<p>For backing up our production database, there are a few things to consider:</p>
<ul class="simple">
<li><p>We want <em>incremental backups</em>. Rather than backing up the entire database every time we make a backup, we’d like to just back up what’s new since last time, and add that to a backup archive. We can slice these increments on the <code class="docutils literal notranslate"><span class="pre">date_added</span></code> field.</p></li>
<li><p>But, profiles are not immutable; they may be updated over time, causing the same profile to appear in multiple backup increments. Therefore, we can’t assume the version of a profile in an arbitrary increment of our archive is up to date; a later increment might alter it, so the restoration process must be a <em>chronological upsert</em>.</p></li>
<li><p>Finally, we have to entertain the possibility that the production database has been updated since the last backup; the restoration procedure must also be able to recreate these un-backed up changes.</p></li>
</ul>
<p>One strategy that accommodates this is as follows:</p>
<ul>
<li><p>Make a backup increment daily, weekly or monthly with <code class="docutils literal notranslate"><span class="pre">mongoexport</span></code>, for example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mongoexport --db<span class="o">=</span>argo --collection<span class="o">=</span>profiles --query<span class="o">=</span><span class="s1">&#39;{&quot;date_added&quot;: {&quot;$gte&quot;: {&quot;$date&quot;: &quot;2021-12-01T00:00:00Z&quot;}, &quot;$lt&quot;: {&quot;$date&quot;: &quot;2022-01-01T00:00:00Z&quot;}}}&#39;</span> --out<span class="o">=</span>export.json
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>Note this is different than the <code class="docutils literal notranslate"><span class="pre">.bson</span></code> files produced by <code class="docutils literal notranslate"><span class="pre">mongodump</span></code> that we entertained in the above section. The corresponding <code class="docutils literal notranslate"><span class="pre">mongorestore</span></code> doesn’t have an upsert option, and is therefore inappropriate for incremental backups.</p>
</div></blockquote>
<ul>
<li><p>Restore your backup, making sure to do so in chronological order and using the <code class="docutils literal notranslate"><span class="pre">--mode=upsert</span></code> flag:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mongoimport --db<span class="o">=</span>argo --collection<span class="o">=</span>profiles --mode<span class="o">=</span>upsert export.json
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition-warning admonition">
<p class="admonition-title">Warning</p>
<p>As above, this is a memory hungry process. When recovering from a disaster so severe you need to restore from cold backups, consider tearing down all stateless apps and allocating as much memory as possible to mongodb, at least 16 GB as of this writing.</p>
</div>
<ul>
<li><p>The above will of course only restore the database up to the last incremental backup. To complete the database reconstruction, we need to replay the nightly updates that ran since the last backup. Replace the default CMD in <code class="docutils literal notranslate"><span class="pre">argovis/datacron</span></code> with (adjusting the dates appropriately):</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python add_profiles.py --dbName argo --subset tmp --logName /usr/src/argo-database/logs/tmp.log --npes <span class="m">1</span> --minDate <span class="m">2021</span>-12-13 --maxDate <span class="m">2021</span>-12-15
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><p>and run to catch the restored database up to the latest.</p>
</div></blockquote>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">mongoexport</span></code> backups don’t back up indexes by default. Recreate them from the mongo shell (below are examples, need to keep track or back up actual index plans):</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;timestamp&quot;</span>: -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;platform_id&quot;</span> : -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;data_center&quot;</span> : -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;geolocation&quot;</span> : <span class="s2">&quot;2dsphere&quot;</span><span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;source_info.source&quot;</span> : -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;platform_id&quot;</span> : -1, <span class="s2">&quot;timestamp&quot;</span> : -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;timestamp&quot;</span> : -1, <span class="s2">&quot;platform_id&quot;</span> : -1<span class="o">})</span>
db.profilesx.createIndex<span class="o">({</span><span class="s2">&quot;date_updated_argovis&quot;</span> : -1<span class="o">})</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../special_topics/connecting_to_the_container_network.html" class="btn btn-neutral float-right" title="Connecting to the Container Network" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../dev_tools/using_branches.html" class="btn btn-neutral float-left" title="Using Branches" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Argovis Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>