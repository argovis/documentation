

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Argovis Kubernetes Deployment &mdash; argovis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Performance Testing" href="performance_testing.html" />
    <link rel="prev" title="Creating Custom Angular Components" href="../getting_started/custom_angular_components.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> argovis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/set_up_dev_environment.html">Setting Up Argovis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/api_development.html">API Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/custom_angular_components.html">Creating Custom Angular Components</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations Playbooks</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Argovis Kubernetes Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#application-architecture">Application Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setup">Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#first-time-setup">First Time Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#deploying-with-helm">Deploying with Helm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-config">API Config</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance_testing.html">Performance Testing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../data_management/data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_management/point_schema.html">Point Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_management/grid_schema.html">Grid Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data_management/argo_merge.html">Merging Argo Data</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Tools &amp; Techniques</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/fast_development_builds.html">Fast Angular Builds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/pull_requests_and_github.html">Pull Requests, Git &amp; GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/merge_conflicts.html">Dealing With Merge Conflicts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_tools/using_branches.html">Using Branches</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Disaster Recovery</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../disaster_recovery/restore_a_mongo_collection.html">Restore Mongo from Backup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Special Topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/connecting_to_the_container_network.html">Connecting to the Container Network</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/goship-demo.html">Goship Demo Rebuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special_topics/profiles-alpha.html">Profiles API Alpha Product</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">argovis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Argovis Kubernetes Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/ops/deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="argovis-kubernetes-deployment">
<span id="deployment"></span><h1>Argovis Kubernetes Deployment<a class="headerlink" href="#argovis-kubernetes-deployment" title="Permalink to this headline">¶</a></h1>
<p>Argovis is architected as a Kubernetes application, to take advantage of that platform’s scalability, security and orchestration features. In this tutorial, we’ll tour the high level structure of the application, and step through what to set up for a generic Kube environment.</p>
<div class="section" id="application-architecture">
<h2>Application Architecture<a class="headerlink" href="#application-architecture" title="Permalink to this headline">¶</a></h2>
<p>Argovis is deployed to Kubernetes as the following diagram:</p>
<img alt="../_images/argovis-architecture.png" src="../_images/argovis-architecture.png" />
<ul class="simple">
<li><p>Deployments:</p>
<ul>
<li><p>an off-the-shelf containerized version of mongodb holds all our raw data.</p></li>
<li><p><a class="reference external" href="https://github.com/argovis/argovis_api">argovis_api</a> brokers access to mongo with a RESTful, OpenAPI compliant API.</p></li>
<li><p><a class="reference external" href="https://github.com/argovis/argovis_redis">argovis_redis</a> is a redis database with some custom config is used by the API to keep track of API requests, and throttle users that issue fast requests that threaten to swamp the database or network.</p></li>
<li><p><a class="reference external" href="https://github.com/argovis/argovisNg">argovisNg</a> is an Angular based web frontend for exploring the data.</p></li>
<li><p><a class="reference external" href="https://github.com/argovis/datapages">datapages</a> are additional frontend pages built independently from Angular.</p></li>
</ul>
</li>
<li><p>Cronjobs:</p>
<ul>
<li><p><a class="reference external" href="https://github.com/argovis/datacron">datacron</a> runs nightly to fetch new profile data from ifremer and load it into mongodb.</p></li>
</ul>
</li>
<li><p>PersistentVolumes:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mongoback</span></code> is the database backing for mongodb, recommended at least 100 GB.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datacron-logs</span></code> is a small backing for the logs of the database update job, typically 10 GB.</p></li>
</ul>
</li>
<li><p>Configs:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">apitoken</span></code> (secret): used to mount an API token for use by the frontend containers.</p></li>
</ul>
</li>
<li><p>Networking:</p>
<ul>
<li><p>The API and both frontends have nodePort services allowing ingress. Depending on Kube provider, ingress from the internet will be provided by differing objects; OKD uses Red Hat Routes, for example.</p></li>
<li><p>Both databases have clusterIP services for internal communication.</p></li>
<li><p>networkPolicies are applied to both databases to only allow access from pods with the label <code class="docutils literal notranslate"><span class="pre">app:</span> <span class="pre">api</span></code>.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>When deploying Argovis, perform the following steps. Details might change slightly depending on the specific Kube cluster being deployed to; see inline links for details.</p>
<div class="section" id="first-time-setup">
<h3>First Time Setup<a class="headerlink" href="#first-time-setup" title="Permalink to this headline">¶</a></h3>
<p>A few objects need to be created by hand the first time Argovis is deployed to a new cluster:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mongoback</span></code> PV/PVC: 100 GB or bigger.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datacron-logs</span></code> PV/PVC: about 10 GB.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apitoken</span></code> secret: a secret with a single key <code class="docutils literal notranslate"><span class="pre">token</span></code> containing a string for use as an API token by the frontend pods.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datacron</span></code> cronjob: see source and deployment yaml <a class="reference external" href="https://github.com/argovis/datacron">here</a>.</p></li>
</ul>
</div></blockquote>
<p>Once these have been created, you’re ready to deploy the application with Helm.</p>
</div>
<div class="section" id="deploying-with-helm">
<h3>Deploying with Helm<a class="headerlink" href="#deploying-with-helm" title="Permalink to this headline">¶</a></h3>
<p>See the deployment instructions in <a class="reference external" href="https://github.com/argovis/argovis_deployment">this repo</a> for a Helm chart to deploy the five main deployments and networking elements of Argovis. After first-time setup is complete, code revisions can be managed with <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span></code> and <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">rollback</span></code>, and full teardowns and redeployments can be safely made with <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span></code> and <code class="docutils literal notranslate"><span class="pre">uninstall</span></code>.</p>
</div>
<div class="section" id="api-config">
<h3>API Config<a class="headerlink" href="#api-config" title="Permalink to this headline">¶</a></h3>
<p>The first time you deploy to a new cluster, make sure to connect to mongo and register the api token you defined in the <code class="docutils literal notranslate"><span class="pre">apitoken</span></code> secret:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>~ $ kubectl <span class="nb">exec</span> -it &lt;mongo pod name&gt; mongo

&gt; use argo
&gt; db.user.insertOne<span class="o">({</span>key: <span class="s2">&quot;&lt;token you defined in secret&gt;&quot;</span>, tokenValid: <span class="m">1</span><span class="o">})</span>
&gt; <span class="nb">exit</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="performance_testing.html" class="btn btn-neutral float-right" title="Performance Testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../getting_started/custom_angular_components.html" class="btn btn-neutral float-left" title="Creating Custom Angular Components" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Argovis Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>