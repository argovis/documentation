

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>API rate limitation &mdash; argovis  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> argovis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../database/schema.html">Argovis data schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="qsp.html">API Query String Parameters</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">argovis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>API rate limitation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/api/rate_limitation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="api-rate-limitation">
<span id="api-rate-limit"></span><h1>API rate limitation<a class="headerlink" href="#api-rate-limitation" title="Permalink to this headline">¶</a></h1>
<p>In order to prevent rapid, large requests from overwhelming and crashing Argovis’ servers, API requests are <em>rate limited</em> by a simple token bucket algorithm:</p>
<blockquote>
<div><ul class="simple">
<li><p>Every user has a bucket of tokens of finite capacity</p></li>
<li><p>Every API request costs some amount of tokens</p></li>
<li><p>If a user makes a request while they have a negative token balance, the request will be rejected (HTTP 429)</p></li>
<li><p>Each user’s token bucket automatically refills to capacity at a constant rate over time.</p></li>
</ul>
</div></blockquote>
<p>In this document, we will discuss how this is implemented in Argovis.</p>
<div class="section" id="user-identification">
<h2>User identification<a class="headerlink" href="#user-identification" title="Permalink to this headline">¶</a></h2>
<p>In order to distinguish users, Argovis accepts a user API key via the <code class="docutils literal notranslate"><span class="pre">x-argokey</span></code> request header. Users can request a personal key by registering with their name and email via our key generation service (code: <a class="reference external" href="https://github.com/argovis/apikey-manager">https://github.com/argovis/apikey-manager</a>, deployment: <a class="reference external" href="https://github.com/argovis/argovis_deployment/blob/main/argovis/templates/keymanager-deployment.yaml">https://github.com/argovis/argovis_deployment/blob/main/argovis/templates/keymanager-deployment.yaml</a>). This service provides basic email-authenticated CRUD operations against the <code class="docutils literal notranslate"><span class="pre">argo.user</span></code> collection in MongoDB.</p>
<p>Note that this key management service uses Sendgrid as an email backend to communicate with users; as such, it looks for a valid Sendgrid API token in the environment variable <code class="docutils literal notranslate"><span class="pre">SENDGRID_API_KEY</span></code>. This environment variable should in turn be provided by a properly encrypted secret management service available in both Kubernetes and Swarm.</p>
<p>In addition to user-generated keys, the string <code class="docutils literal notranslate"><span class="pre">guest</span></code> is a valid API key. Any API request that doesn’t have an <code class="docutils literal notranslate"><span class="pre">x-argovis</span></code> header is treated as if it had <code class="docutils literal notranslate"><span class="pre">x-argovis:</span> <span class="pre">guest</span></code>. As a result, unauthenticated requests can be made, but globally share a single token bucket allocation.</p>
</div>
<div class="section" id="balance-management">
<h2>Balance management<a class="headerlink" href="#balance-management" title="Permalink to this headline">¶</a></h2>
<p>In order to mitigate continuous reads and writes to MongoDB, active balance management is done in memory with a simple Redis deployment (code: <a class="reference external" href="https://github.com/argovis/argovis_redis">https://github.com/argovis/argovis_redis</a>, deployment: <a class="reference external" href="https://github.com/argovis/argovis_deployment/blob/main/argovis/templates/redis-deployment.yaml">https://github.com/argovis/argovis_deployment/blob/main/argovis/templates/redis-deployment.yaml</a>). Redis should be up and running before launching API containers.</p>
</div>
<div class="section" id="request-pricing-and-bucket-configuration">
<h2>Request pricing and bucket configuration<a class="headerlink" href="#request-pricing-and-bucket-configuration" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference external" href="https://github.com/argovis/argovis_api/blob/server/nodejs-server/middleware/ratelimiter/tokenbucket.js">our token bucket implementation</a> for global bucket sizing, refill rates, and price scale setting. At high level, we penalize requests with large temporospatial extent, and discount requests that are for metadata only.</p>
<p>For route-specific details, see the <code class="docutils literal notranslate"><span class="pre">cost</span></code> function in <a class="reference external" href="https://github.com/argovis/argovis_api/blob/server/nodejs-server/helpers/helpers.js">https://github.com/argovis/argovis_api/blob/server/nodejs-server/helpers/helpers.js</a>. This function returns the price of a given request as a function of its route and query string, and is the correct place to make token price adjustments on a case-by-case basis.</p>
</div>
<div class="section" id="satellite-deployments">
<h2>Satellite deployments<a class="headerlink" href="#satellite-deployments" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">user</span></code> collection is maintained exclusively in the Argovis Core MongoDB, and not in satellite deployments such as our deployment for the Global Drifter Program. In order to allow satellite deployments to validate API tokens, instead of looking them up in MongoDB, they can make a request against the <code class="docutils literal notranslate"><span class="pre">/token</span></code> API endpoint of the Argovis Core deployment to check if an API token is valid, and from there maintain a balance for that user in its local Redis. As such, users actually have independent balances for independent Argovis deployments, while still being able to use a single key across them all.</p>
<p><em>Last reviewed 23-03-08</em></p>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Argovis Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>